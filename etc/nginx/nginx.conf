user  nginx;

worker_processes  1;

# load_module lib64/nginx/modules/ngx_http_fancyindex_module.so;
# load_module lib64/nginx/modules/ngx_http_headers_more_filter_module.so;
# load_module lib64/nginx/modules/ngx_http_image_filter_module.so;
# load_module lib64/nginx/modules/ngx_http_perl_module.so;
# load_module lib64/nginx/modules/ngx_http_xslt_filter_module.so;
# load_module lib64/nginx/modules/ngx_mail_module.so;
# load_module lib64/nginx/modules/ngx_rtmp_module.so;
# load_module lib64/nginx/modules/ngx_stream_module.so;

error_log  /var/log/nginx/error.log  debug;
#error_log  /var/log/nginx/error.log  notice;
#error_log  /var/log/nginx/error.log  info;

pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
    use epoll;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 512M;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"'
		      '"$fastcgi_script_name" "$document_root"'
		      '"$document_uri" "$request_uri"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    include conf.d/*.conf;

    #redirect http to https
    server {
        listen *:80;
        server_name belthelziquor.com www.belthelziquor.com;

        if ($host = belthelziquor.com) {
            return 301 https://$host$request_uri;
        } # managed by Certbot

        return 404; # managed by Certbot
    }

    #main website
    server {
		listen 443 ssl; # managed by Certbot
		server_name belthelziquor.com www.belthelziquor.com;
		root /srv/www/homesite_laravel/public/;
    ssl_certificate /etc/letsencrypt/live/belthelziquor.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/belthelziquor.com/privkey.pem; # managed by Certbot
		include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
		ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

		location / {
			index index.php;
			try_files $uri $uri/ /index.php?$query_string;
		}

		location ~ \.php$ {
			fastcgi_split_path_info       ^(.+\.php)(.*)$;
			#fastcgi_pass localhost:9005;
			fastcgi_pass unix:/var/run/php-fpm/php8-fpm.sock;
			fastcgi_index index.php;
			include fastcgi_params;
			fastcgi_param SCRIPT_FILENAME /srv/www/homesite_laravel/public/$fastcgi_script_name;
			fastcgi_param SCRIPT_NAME $fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;
		}

        #other paths. TODO verify these or move to laravel app if needed
        #websocket app
		location /ws/ {
			proxy_pass https://192.168.1.171:9002;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_cache_bypass $http_upgrade;
		}

		location /focalboard/ { #temporary fix because cant get ssl forward to work
			return http://belthelziquor.com:8000/focalboard/;
		}
		#location /filestash/ {
		#	return http://belthelziquor.com:8334;
		#}	
		location /draw/ {
			return http://belthelziquor.com:7000;
		}
		location /boogisdialogue/ {
			return http://belthelziquor.com:7070;
		}

		location /ngstat/ {
			stub_status on;
			#allow 192.168.4.0/24;
			allow 127.0.0.1;
			deny all;
		}
    

	

}

    #TODO figure out
    #drawing board ssl
    #server {
        #listen #9002 ssl;
        #server_name belthelziquor.com;
	
        #ssl_certificate /etc/letsencrypt/live/belthelziquor.com/fullchain.pem; # managed by Certbot
        #ssl_certificate_key /etc/letsencrypt/live/belthelziquor.com/privkey.pem; # managed by Certbot
        #include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        #ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

        #location / {
         #   proxy_pass http://localhost:7000;
          #  proxy_set_header Host $host:$server_port;
           # proxy_set_header X-Real-IP $remote_addr;
            #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           # proxy_set_header X-Forwarded-Proto $scheme;
        #}

    #}

    include vhosts.d/*.conf;
}



#location /idrac/ {
#	proxy_pass http://192.168.5.24;
#	proxy_http_version 1.1;
#	proxy_set_header Upgrade $http_upgrade;
#	proxy_set_header Connection 'upgrade';
#	proxy_set_header Host $host;
#	proxy_set_header X-Real-IP $remote_addr;
#	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#	proxy_cache_bypass $http_upgrade;
#}
